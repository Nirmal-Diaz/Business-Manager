<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%;">

<head>
    <meta charset="UTF-8">
    <title>Create User</title>

    <link rel="stylesheet" href="../../stylesheets/platform_styleVariables_turquoise.css" />
    <link rel="stylesheet" href="../../stylesheets/platform_styles.css">
    <link rel="stylesheet" href="../../stylesheets/popUpCard_styles.css" />

    <script type="module">
        //@ts-check
        import {PlatformComponent} from "../../scripts/Utility.mjs";
        //Prevent contextMenu
        window.addEventListener("contextmenu", (event) => {
            event.preventDefault();
        });
        //Add onload to window for initializing popUpCardInterface
        window.addEventListener("load", () => {
            window.popUpCardInterface = new PopUpCardInterface();
        });

        class PopUpCardInterface {
            popUpCardObject = null;
            title = document.querySelector("title").textContent;
            
            closeButtons = document.querySelectorAll(".closeButton");
            usernameTextInput = document.getElementById("usernameTextInput");
            roleDropDownInput = document.getElementById("roleDropDownInput");
            moduleDropDownInput = document.getElementById("moduleDropDownInput");

            constructor() {
                //Fetch roles
                fetch(`${location.protocol}//${location.host}/general?tableName=role`)
                .then(response => response.json())
                .then(response => {
                    if (response.status) {
                        this.roleDropDownInput.innerHTML = "";
                        //Create a dropDownInputOption for every role
                        for (const role of response.data) {
                            const dropDownInputOption = PlatformComponent.createDropDownInputOption(role.name, JSON.stringify(role), null);
                            this.roleDropDownInput.appendChild(dropDownInputOption);
                        }
                        //Make the first dropDownOption selected
                        this.roleDropDownInput.firstElementChild.click();
                    } else {
                        window.parent.shellInterface.throwAlert(response.error.title, response.error.titleDescription, response.error.message, null, "OK", null);
                    }
                })
                .catch(error => {
                    window.parent.shellInterface.throwAlert("Oops! We couldn't fetch that", "Contact your system administrator", "We couldn't fetch roles list from the internal server. The most likely cause may be a network failure. If it is not the case, provide your system administrator with the following error\n\n" + error, null, "OK", null);
                });
                //Add onclick to saveButton for submitting the form
                document.getElementById("saveButton").addEventListener("click", () => {
                    const username = this.usernameTextInput.value;
                    const user = {
                        roleId: this.roleDropDownInput.value,
                    };
                    const userModulePermissions = [];
                    for (const moduleDropDownInputOption of this.moduleDropDownInput.children) {
                        //UserModulePermissions with "0000" must be ignored
                        if (moduleDropDownInputOption.dataset.permissions !== "0000") {
                            const userModulePermission = {
                                moduleId: moduleDropDownInputOption.dataset.moduleId,
                                permissions: moduleDropDownInputOption.dataset.permissions
                            };
                            userModulePermissions.push(userModulePermission);
                        }
                    }
                    //Send data to server
                    fetch(`${location.protocol}//${location.host}/user`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            username: username,
                            user: user,
                            userModulePermissions: userModulePermissions
                        })
                    }).then((response) => {
                        return response.json();
                    }).then((response) => {
                        if (response.status) {
                            //Re-fetch users list
                            this.popUpCardObject.parentCardInterface.searchItems("", "Users", "Double tap to find out more");
                            //Close the popUpCard
                            this.popUpCardObject.close();
                        } else {
                            window.parent.shellInterface.throwAlert(response.error.title, response.error.titleDescription, response.error.message, null, "OK", null);
                        }
                    }).catch((error) => {
                        window.parent.shellInterface.throwAlert("Oops! We couldn't send that", "Contact your system administrator", "We couldn't send new user details to the internal server. The most likely cause may be a network failure. If it is not the case, provide your system administrator with the following error\n\n" + error, null, "OK", null);
                    });
                });
            }
        }
    </script>
</head>

<body>
    <div class="popUpDivision">
        <!-- formTitleContainer -->
        <div class="formTitleContainer">
            <div class="titleContainer">
                <div class="title">Create User</div>
            </div>
        </div>

        <!-- formFieldsContainer -->
        <div class="formFieldsContainer">
            <div class="titleContainer">
                <h1 class="title">Username</h1>
            </div>
            <p>The username must consist only of letters. Try using at most two names</p>
            <div class="inputContainer" data-submit="true">
                <input id="usernameTextInput" type="text" class="textInput" placeholder="eg: John Doe" />
            </div>
            <div class="titleContainer">
                <h1 class="title">Role</h1>
            </div>
            <di class="inputContainer">
                <div id="roleDropDownInput" class="dropDownInput" data-value="null">

                </div>
            </di>
            <!-- <div class="titleContainer">
                <h1 class="title">Modules + Operations</h1>
            </div>
            <p>Every module has four operations. Create, retrieve, update and delete. Although you can apply other
                permissions without "retrieve" permission, The user won't be able to view the module</p>
            <div class="inputContainer">
                <div id="moduleDropDownInput" class="dropDownInput" data-value="null">

                </div>
            </div>
            <div id="permissionCheckInputContainer" class="inputContainer">
                <div class="checkInput" data-permission-index="0">
                    <div class="checkRadioInputControl"><span>C</span></div>
                    <div class="checkRadioInputLabel">
                        <span>Create</span>
                        <span>Module Name</span>
                    </div>
                </div>
                <div class="checkInput" data-permission-index="1">
                    <div class="checkRadioInputControl"><span>R</span></div>
                    <div class="checkRadioInputLabel">
                        <span>Retrieve</span>
                        <span>Module Name</span>
                    </div>
                </div>
                <div class="checkInput" data-permission-index="2">
                    <div class="checkRadioInputControl"><span>U</span></div>
                    <div class="checkRadioInputLabel">
                        <span>Update</span>
                        <span>Module Name</span>
                    </div>
                </div>
                <div class="checkInput" data-permission-index="3">
                    <div class="checkRadioInputControl"><span>D</span></div>
                    <div class="checkRadioInputLabel">
                        <span>Delete</span>
                        <span>Module Name</span>
                    </div>
                </div>
            </div> -->
        </div>

        <!-- formControlsContainer -->
        <div class="formControlsContainer">
            <button id="saveButton" class="buttonText buttonText-link">SAVE</button>
            <button class="buttonText buttonText-link">CLEAR</button>
            <button class="buttonText buttonText-link closeButton">CLOSE</button>
        </div>
    </div>
</body>

</html>