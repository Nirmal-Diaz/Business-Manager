<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%;">

<head>
    <meta charset="UTF-8">
    <title>Create User</title>

    <link rel="stylesheet" href="../../stylesheets/platform_styleVariables_turquoise.css" />
    <link rel="stylesheet" href="../../stylesheets/platform_styles.css">
    <link rel="stylesheet" href="../../stylesheets/popUpCard_styles.css" />

    <script type="module">
        //@ts-check
        import { FormUtil } from "../../scripts/Utility.js";
        import { Form } from "../../scripts/Form.js";

        //Prevent contextMenu
        window.addEventListener("contextmenu", (event) => {
            event.preventDefault();
        });
        //Add onload to window for initializing popUpCardInterface
        window.addEventListener("load", () => {
            window.popUpCardInterface = new PopUpCardInterface();
        });

        class PopUpCardInterface {
            popUpCardObject = null;
            title = document.querySelector("title").textContent;
            roleForm = new Form(document.getElementById("roleForm"));
            permissionForm = new Form(document.getElementById("permissionForm"));

            closeButtons = document.querySelectorAll(".closeButton");

            constructor() {
                //Initialize roleForm
                this.roleForm.init("role.json");
                this.permissionForm.init("permissions.json").then((form) => {
                    //NOTE: The form.bindingObject is an array. It contains a reference permission object
                    //NOTE: That reference object must be backed up and removed from the array (Removal will be done automatically)
                    const stringifiedRefPermission = JSON.stringify(form.getBindingObject()[0]);
                    //Load modules and select option with value "1"
                    FormUtil.createDropDownInputFragment("/general?tableName=module", "name", "id")
                        .then((dropDownInputFragment) => {
                            const dropDownInput = form.getView().querySelector("#moduleId");

                            dropDownInput.appendChild(dropDownInputFragment);

                            const moduleId2BindingObjectIndex = {
                                // "1": 4
                            }

                            //Create a moduleId2BindingObjectIndex entry and a permission object for each option tag
                            for (let i = 0; i < dropDownInput.childElementCount; i++) {
                                moduleId2BindingObjectIndex[dropDownInput.children[i].value] = i;
                                form.getBindingObject()[i] = JSON.parse(stringifiedRefPermission);
                            }

                            //Add onchange to DropDownInput for updating checkInputs with the current value
                            dropDownInput.addEventListener("change", (event) => {
                                const moduleId = dropDownInput.value;
                                const bindingObjectIndex = moduleId2BindingObjectIndex[moduleId];
                                const permissionValue = form.getBindingObject()[bindingObjectIndex].value.value;

                                const checkInputs = form.getView().querySelectorAll(".checkInput");
                                for (let i = 0; i < 4; i++) {
                                    if (permissionValue[i] === "1") {
                                        checkInputs[i].checked = true;
                                    } else {
                                        checkInputs[i].checked = false;
                                    }
                                }
                            });

                            //Add onclick to every checkInput for updating relevant permission object's value
                            const checkInputs = form.getView().querySelectorAll(".checkInput");
                            for (let i = 0; i < 4; i++) {
                                checkInputs[i].addEventListener("change", (event) => {
                                    const selectedModuleId = dropDownInput.value;
                                    const bindingObjectIndex = moduleId2BindingObjectIndex[selectedModuleId];
                                    const splitPermissionValue = form.getBindingObject()[bindingObjectIndex].value.value.split("");

                                    if (checkInputs[i].checked) {
                                        splitPermissionValue[i] = "1";
                                    } else {
                                        splitPermissionValue[i] = "0";
                                    }
                                    form.getBindingObject()[bindingObjectIndex].value.value = splitPermissionValue.join("");
                                    console.log(form.getBindingObject()[bindingObjectIndex]);
                                });
                            }
                        });
                });


                //Get the list of modules and create relevant input for each module
                // fetch(`${location.protocol}//${location.host}/general?tableName=module`)
                //     .then(response => response.json())
                //     .then(response => {
                //         if (response.status) {
                //             const inputGroupsFragment = new DocumentFragment();
                //             //Create a dropDownInputOption for every item
                //             for (const item of response.data) {
                //                 const inputGroup = this.templateContainerFragment.querySelector("#moduleId2ValueInputGroup").cloneNode(true);
                //                 inputGroup.querySelector(".titleDescription").textContent = item.name;
                //                 inputGroup.querySelector(".inputContainer").dataset.moduleId = item.id;

                //                 const checkInputs = inputGroup.querySelectorAll(".input");
                //                 for (const checkInput of checkInputs) {
                //                     checkInput.addEventListener("change", (event) => {
                //                         const inputCrudIndex = Number.parseInt(checkInput.dataset.crudIndex);
                //                         const splitValue = checkInput.parentElement.dataset.value.split("");
                //                         if (checkInput.checked) {
                //                             splitValue[inputCrudIndex] = "1";
                //                         } else {
                //                             splitValue[inputCrudIndex] = "0";
                //                         }
                //                         checkInput.parentElement.dataset.value = splitValue.join("");
                //                     });
                //                 }

                //                 inputGroupsFragment.appendChild(inputGroup);
                //             }
                //             document.querySelector(".formFieldsContainer").appendChild(inputGroupsFragment);
                //         } else {
                //             window.parent.shellInterface.throwAlert(response.error.title, response.error.titleDescription, response.error.message, null, "OK", null);
                //             return null;
                //         }
                //     })
                //     .catch(error => {
                //         window.parent.shellInterface.throwAlert("Oops! We couldn't fetch that", "Contact your system administrator", "We couldn't fetch roles list from the internal server. The most likely cause may be a network failure. If it is not the case, provide your system administrator with the following error\n\n" + error, null, "OK", null);
                //     });

                // //Add onclick to saveButton for submitting the form
                // document.getElementById("saveButton").addEventListener("click", () => {
                //     this.form.submit("/user", () => {
                //         //Refresh (not reload) the parentCardInterface
                //         this.popUpCardObject.parentCardInterface.searchItems("", "We've got a new user", "Double tap to find out more");
                //         //Close this popUpCard
                //         this.popUpCardObject.close();
                //     });
                // });
            }
        }
    </script>
</head>

<body>
    <div class="popUpDivision">
        <!-- formTitleContainer -->
        <div class="formTitleContainer">
            <div class="titleContainer">
                <div class="title">Create Role</div>
            </div>
        </div>

        <!-- formsContainer -->
        <div class="formsContainer">
            <form id="roleForm">
                <div class="titleContainer">
                    <h1 class="title">Role Name</h1>
                </div>
                <ul>
                    <li>Must consist only of letters and numbers</li>
                    <li>Both uppercase and lowercase letters are allowed</li>
                    <li>No spaces are allowed</li>
                </ul>
                <div class="inputContainer">
                    <input id="name" type="text" class="input textInput" placeholder="eg: myRole1" />
                </div>
            </form>
            <form id="permissionForm">
                <div class="titleContainer">
                    <h1 class="title">Module Permissions</h1>
                </div>
                <p>The role determines a user's permissions on each module</p>
                <p>If the role you want isn't listed below, go and add it in before proceeding</p>
                <div class="inputContainer">
                    <select id="moduleId" class="input dropDownInput">

                    </select>
                </div>
                <div class="inputGroup">
                    <div class="inputContainer">
                        <input type="checkbox" class="input checkInput">
                        <label>Create</label>
                    </div>
                    <div class="inputContainer">
                        <input type="checkbox" class="input checkInput">
                        <label>Retrieve</label>
                    </div>
                    <div class="inputContainer">
                        <input type="checkbox" class="input checkInput">
                        <label>Update</label>
                    </div>
                    <div class="inputContainer">
                        <input type="checkbox" class="input checkInput">
                        <label>Delete</label>
                    </div>
                </div>
            </form>
        </div>

        <!-- formControlsContainer -->
        <div class="formControlsContainer">
            <button id="saveButton" class="buttonText buttonText-link">SAVE</button>
            <button class="buttonText buttonText-link">CLEAR</button>
            <button class="buttonText buttonText-link closeButton">CLOSE</button>
        </div>
    </div>
</body>

</html>