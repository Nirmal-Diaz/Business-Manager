<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%;">

<head>
    <meta charset="UTF-8">
    <title>Create/Update User</title>

    <link rel="stylesheet" href="/stylesheets/main/platform_variables_turquoise.css" />
    <link rel="stylesheet" href="/stylesheets/main/platform.css">
    <link rel="stylesheet" href="/stylesheets/main/popUpCard.css" />

    <script type="module">
        //@ts-check
        import { FormUtil } from "/scripts/main/Utility.js";
        import { Form } from "/scripts/main/Form.js";
        import { BasePopUpCardInterface } from "/scripts/main/BasePopUpCardInterface.js";
        
        //Add onload to window for initializing popUpCardInterface
        window.addEventListener("DOMContentLoaded", () => {
            window.popUpCardInterface = new PopUpCardInterface();
        });

        class PopUpCardInterface extends BasePopUpCardInterface {
            form = new Form(document.querySelector("form"));

            constructor() {
                super();
                //TODO: Only update the selectedCardDivisionSectorItem when updating an item
                //Add onclick to saveButton for submitting the form
                document.getElementById("saveButton").addEventListener("click", () => {
                    this.form.submit().then(submission => {
                        if (submission.status) {
                            //Refresh (not reload) the parentCardInterface
                            if (this.form.getSubmissionMethod() === "PUT") {
                                this.popUpCardObject.parentCardInterface.searchItems("", "We've got a new user", "Double tap to view and update");
                            } else if (this.form.getSubmissionMethod() === "POST") {
                                this.popUpCardObject.parentCardInterface.searchItems("", "You've updated a user recently", "Double tap to view");
                            }
                            //Close this popUpCard
                            this.popUpCardObject.close();
                        } else {
                            window.parent.shellInterface.throwAlert(submission.error.title, submission.error.titleDescription, submission.error.message, null, "OK", null);
                        }
                    });
                });

                document.getElementById("resetButton").addEventListener("click", () => {
                    this.form.resetInputs();
                });

                document.getElementById("printButton").addEventListener("click", () => {
                    print();
                });
            }

            initInputs() {
                return Promise.all([
                    //Load roles and select option with value "1"
                    FormUtil.createDropDownInputFragment("/roles?keyword=", "name", "id")
                        .then(dropDownInputFragment => this.form.getView().querySelector("#roleId").appendChild(dropDownInputFragment))
                ]);
            }

            initCreateForm() {
                //Initialize form
                this.form.init("/registries/user.json", "/users", "PUT");
            }

            initUpdateForm(selectedCardDivisionSectorItem) {
                document.querySelector(".formTitleContainer .titleDescription").textContent = "Update";
                //Cache the selectedCardDivisionSectorItem to replace it after the update
                const selectedItemId = selectedCardDivisionSectorItem.dataset.bindingObjectId;

                //Initialize form
                this.form.init("/registries/user.json", `/users/${selectedItemId}`, "POST").then((form) => {
                    //Load plainObject
                    fetch(`/users/${selectedItemId}`)
                        .then(response => response.json())
                        .then(response => {
                            if (response.status) {
                                this.form.mapToBindingObject(this.form.getBindingObject(), response.data);
                                //Update the inputs according to the binding object
                                this.form.updateInputs(this.form.getBindingObject());
                            } else {
                                window.parent.shellInterface.throwAlert(response.error.title, response.error.titleDescription, response.error.message, null, "OK", null);
                            }
                        })
                        .catch(error => {
                            window.parent.shellInterface.throwAlert("Aw! snap", "Contact your system administrator", "We couldn't fetch the required user from the internal registry. The most likely cause may be a network failure. If it is not the case, provide your system administrator with the following error\n\n" + error, null, "OK", null);
                        })
                });
            }
        }
    </script>
</head>

<body>
    <div class="popUpDivision">
        <!-- formTitleContainer -->
        <div class="formTitleContainer">
            <div class="titleContainer">
                <div class="titleDescription">Create</div>
                <div class="title">User</div>
            </div>
        </div>

        <!-- formsContainer -->
        <div class="formsContainer">
            <form>
                <div class="titleContainer">
                    <h1 class="title">Username</h1>
                </div>
                <ul>
                    <li>Must be unique</li>
                    <li>Must consist only of letters and numbers</li>
                    <li>Both uppercase and lowercase letters are allowed</li>
                    <li>No spaces are allowed</li>
                </ul>
                <div class="inputContainer">
                    <input id="username" type="text" class="input textInput" placeholder="eg: johnDoe123" />
                </div>

                <div class="titleContainer">
                    <h1 class="title">Employee Code</h1>
                </div>
                <ul>
                    <li>Every user has a corresponding employee</li>
                </ul>
                <div class="inputContainer">
                    <input id="employeeCode" type="text" class="input textInput" placeholder="eg: PCB1125">
                </div>

                <div class="titleContainer">
                    <h1 class="title">Role</h1>
                </div>
                <ul>
                    <li>The role determines a user's permissions on each module</li>
                    <li>If the role you want isn't listed below, go and add it in before proceeding</li>
                </ul>
                <div class="inputContainer dropDown">
                    <select id="roleId" class="input dropDownInput">

                    </select>
                </div>
            </form>
        </div>

        <!-- formControlsContainer -->
        <div class="formControlsContainer">
            <button id="saveButton" class="buttonText link">SAVE</button>
            <button id="printButton" class="buttonText link">PRINT</button>
            <button id="resetButton" class="buttonText link">RESET</button>
            <button class="buttonText link closeButton">CLOSE</button>
        </div>
    </div>
</body>

</html>