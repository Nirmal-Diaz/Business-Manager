<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%;">

<head>
    <meta charset="UTF-8">
    <title>Update User Preferences</title>

    <link rel="stylesheet" href="/stylesheets/main/platform_variables_turquoise.css" />
    <link rel="stylesheet" href="/stylesheets/main/platform.css">
    <link rel="stylesheet" href="/stylesheets/main/popUpCard.css" />

    <script type="module">
        //@ts-check
        import { FormUtil } from "/scripts/main/Utility.js";
        import { Form } from "/scripts/main/Form.js";
        import { BasePopUpCardInterface } from "/scripts/main/BasePopUpCardInterface.js";

        //Add onload to window for initializing popUpCardInterface
        window.addEventListener("DOMContentLoaded", () => {
            window.popUpCardInterface = new PopUpCardInterface();
        });

        class PopUpCardInterface extends BasePopUpCardInterface {
            form = new Form(document.querySelector("form"));

            constructor() {
                super();

                document.getElementById("saveButton").addEventListener("click", () => {
                    this.form.submit().then(submission => {
                        if (submission.status) {
                            //Close this popUpCard
                            this.popUpCardObject.close();

                            window.parent.shellInterface.throwAlert("One more step", "Login again to apply changes", "Some UI changes will be applied only after the next login. YOu can logout now and login again to view those changes immediately", null, "OK", null);
                        } else {
                            window.parent.shellInterface.throwAlert(submission.error.title, submission.error.titleDescription, submission.error.message, null, "OK", null);
                        }
                    });
                });

                document.getElementById("resetButton").addEventListener("click", () => {
                    this.form.resetInputs();
                });

                const avatarInput = document.getElementById("avatar");
                //Add onchange to avatarInput for updating the binding object
                avatarInput.addEventListener("change", () => {
                    const avatarBlob = avatarInput.files[0];

                    //NOTE: To improve performance, blobs representations must be strings rather than arrays
                    avatarBlob.arrayBuffer().then((blobArrayBuffer) => {
                        avatarInput.dataset.stringifiedBlob = JSON.stringify(Array.from(new Uint8Array(blobArrayBuffer)));
                    });
                    avatarInput.dataset.size = avatarBlob.size;
                    avatarInput.dataset.type = avatarBlob.type;

                    //Update the sibling img
                    avatarInput.previousElementSibling.src = URL.createObjectURL(avatarBlob);
                });
                //Add onclick to sibling img tag for triggering the click event on the avatarInput
                avatarInput.previousElementSibling.addEventListener("click", () => {
                    avatarInput.click();
                });
            }

            initInputs() {
                return Promise.all([
                    //Load roles and select option with value "1"
                    FormUtil.createDropDownInputFragment("/tables/theme", "name", "id")
                        .then(dropDownInputFragment => this.form.getView().querySelector("#themeId").appendChild(dropDownInputFragment))
                ]);
            }

            initUpdateForm() {
                //Initialize form
                this.form.init("/registries/userPreference.json", "/users/@me/userPreferences", "POST").then((form) => {
                    //Load plainObject
                    fetch("/users/@me/userPreferences")
                        .then(response => response.json())
                        .then(async (response) => {
                            if (response.status) {
                                //NOTE: This method doesn't map blobs to the binding object
                                this.form.mapToBindingObject(this.form.getBindingObject(), response.data);

                                //Update the inputs according to the binding object
                                this.form.updateInputs(this.form.getBindingObject());
                            } else {
                                window.parent.shellInterface.throwAlert(response.error.title, response.error.titleDescription, response.error.message, null, "OK", null);
                            }
                        })
                        .catch(error => {
                            window.parent.shellInterface.throwAlert("Aw! snap", "Contact your system administrator", "We couldn't fetch the required user preferences from the internal registry. The most likely cause may be a network failure. If it is not the case, provide your system administrator with the following error\n\n" + error, null, "OK", null);
                        });
                });
            }
        }
    </script>
</head>

<body>
    <div class="popUpDivision">
        <!-- formTitleContainer -->
        <div class="formTitleContainer">
            <div class="titleContainer">
                <div class="titleDescription">Update</div>
                <div class="title">User Preferences</div>
            </div>
        </div>

        <!-- formsContainer -->
        <div class="formsContainer">
            <form>
                <div class="titleContainer">
                    <h1 class="title">Preferred Name</h1>
                </div>
                <div class="inputContainer">
                    <input id="preferredName" type="text" class="input textInput" placeholder="eg: John" />
                </div>

                <div class="titleContainer">
                    <h1 class="title">Theme</h1>
                </div>
                <div class="inputContainer dropDown">
                    <select id="themeId" class="input dropDownInput">

                    </select>
                </div>

                <div class="titleContainer">
                    <h1 class="title">Avatar</h1>
                    <h1 class="titleDescription">Click to change</h1>
                </div>
                <ul>
                    <li>Must be less than 62KiB</li>
                </ul>
                <div class="inputContainer image">
                    <img src="" alt="">
                    <input id="avatar" type="file" class="input fileInput" />
                </div>
            </form>
        </div>

        <!-- formControlsContainer -->
        <div class="formControlsContainer">
            <button id="saveButton" class="buttonText link">SAVE</button>
            <button id="resetButton" class="buttonText link">RESET</button>
            <button class="buttonText link closeButton">CLOSE</button>
        </div>
    </div>
</body>

</html>