<!DOCTYPE html>
<html lang="en-us" style="height: 100%; width: 100%">

<head>
    <title id="title">Musix&trade;</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="../../manifests/musix.webmanifest" rel="manifest" />
    <link href="../../stylesheets/musix/index.css" rel="stylesheet" />

    <script src="/socket.io/socket.io.js"></script>
    <!-- This script tag will unite the module and global scope -->
    <script>
        //Initialize a new socket with the server
        window.socket = io();
    </script>
    <script type="module">
        //@ts-check
        import { NowPlayingController } from "../../scripts/musix/NowPlayingController.js";
        import { PlaylistExplorerController } from "../../scripts/musix/PlaylistExplorerController.js";
        import { PlaylistController } from "../../scripts/musix/PlaylistController.js";

        //Prevent contextMenu
        window.addEventListener("contextmenu", (event) => {
            event.preventDefault();
        });

        window.addEventListener("load", () => {
            //Initialize cardInterface
            window.cardInterface = new CardInterface();
        });

        class CardInterface {
            cardObject = null;
            title = document.querySelector("title").textContent;
            nowPlayingController = null;
            playlistExplorerController = null;
            playlistsController = null;

            templatesContainerFragment = document.getElementById("templateContainer").content;
            navigationControl = document.getElementById("navigationControl");
            createControls = document.querySelectorAll("#createControlsContainer > button");
            retrieveControls = document.querySelectorAll("#retrieveControlsContainer > button");
            updateControls = document.querySelectorAll("#updateControlsContainer > button");
            deleteControls = document.querySelectorAll("#deleteControlsContainer > button");

            constructor() {
                //Register the service worker
                //NOTE: This must be done only on secure contexts. navigator.serviceWorker isn't available on insecure contexts
                if (window.isSecureContext) {
                    navigator.serviceWorker.register("../../musix.serviceWorker.js", { scope: "musix" });
                }

                //Add webSocket listeners
                this.initWebSocket();

                //Initialize PlaylistsController
                this.playlistsController = new PlaylistController(this);
                this.playlistsController.init().then(() => {
                    //Initialize NowPlayingController and PlaylistExplorerController
                    this.nowPlayingController = new NowPlayingController(this, document.getElementById("nowPlayingViewport"));
                    this.playlistExplorerController = new PlaylistExplorerController(this, document.getElementById("playlistExplorerPanel"));

                });

                //Add events to navigation control
                this.navigationControl.addEventListener("click", () => {
                    this.nowPlayingController.togglePlay();
                });
                this.navigationControl.addEventListener("touchstart", (event) => {
                    this.startNavigation(event);
                });
                this.navigationControl.addEventListener("mousedown", (event) => {
                    this.startNavigation(event);
                });

                this.retrieveControls[0].addEventListener("click", (event) => {
                    this.nowPlayingController.skipTrack("previous");
                });
                this.retrieveControls[1].addEventListener("click", (event) => {
                    this.nowPlayingController.togglePlay();
                });
                this.retrieveControls[2].addEventListener("click", (event) => {
                    this.nowPlayingController.skipTrack("next");
                });

                this.updateControls[0].addEventListener("click", (event) => {
                    this.nowPlayingController.toggleRemotePlay();
                });
            }

            initWebSocket() {
                window.socket.on("remote-disable", (params) => {
                    this.nowPlayingController.setRemotePlay(false);
                });

                window.socket.on("remote-set-volume", (params) => {
                    this.nowPlayingController.setVolume(params.volume);
                });

                window.socket.on("remote-set-playlist", (params) => {
                    this.nowPlayingController.setPlaylist(params.playlist);
                });

                window.socket.on("remote-load-track-at", (params) => {
                    this.nowPlayingController.loadTrackAt(params.trackIndex);
                });

                window.socket.on("remote-seek-to", (params) => {
                    this.nowPlayingController.seekTo(params.time);
                });

                window.socket.on("remote-toggle-play", (params) => {
                    this.nowPlayingController.togglePlay();
                });

                window.socket.on("remote-skip-track", (params) => {
                    this.nowPlayingController.skipTrack(params.direction);
                });
            }

            getTemplate(cssQuery) {
                return this.templatesContainerFragment.querySelector(cssQuery);
            }

            getNavigationControl() {
                return this.navigationControl;
            }

            getWebSocket() {
                return window.socket;
            }

            getNowPlayingController() {
                return this.nowPlayingController;
            }

            getPlaylistExplorerController() {
                return this.playlistExplorerController;
            }

            getPlaylistController() {
                return this.playlistsController;
            }

            //EVENT HANDLER METHODS
            startNavigation(event) {
                const cardInterface = this;

                const originalMousePositionX = event.screenX || event.touches[0].screenX;
                const originalMousePositionY = event.screenY || event.touches[0].screenY;

                window.addEventListener("touchmove", determineProcedure);
                window.addEventListener("mousemove", determineProcedure);
                window.addEventListener("touchend", executeProcedure);
                window.addEventListener("mouseup", executeProcedure);

                let differenceX = 0;
                let differenceY = 0;
                let procedureToExecute = () => { }

                //INNER EVENT HANDLER FUNCTIONS
                function determineProcedure(event) {
                    //Calculate the travelledDistance of the mouse as a vector
                    differenceX = (event.screenX || event.touches[0].screenX) - originalMousePositionX;
                    differenceY = (event.screenY || event.touches[0].screenY) - originalMousePositionY;

                    const absoluteDifferenceX = Math.abs(differenceX);
                    const absoluteDifferenceY = Math.abs(differenceY);
                    if (absoluteDifferenceX >= absoluteDifferenceY) {
                        //Case: x axis must be prioritized
                        if (differenceX > 0) {
                            cardInterface.navigationControl.style.borderWidth = "0 2px 0 0";
                            procedureToExecute = () => {
                                cardInterface.nowPlayingController.skipTrack("next");
                            };
                        } else if (differenceX < 0) {
                            cardInterface.navigationControl.style.borderWidth = "0 0 0 2px";
                            procedureToExecute = () => {
                                cardInterface.nowPlayingController.skipTrack("previous");
                            };
                        }
                    } else {
                        //Case: y axis must be prioritized
                        if (differenceY > 0) {
                            cardInterface.navigationControl.style.borderWidth = "0 0 2px 0";
                            procedureToExecute = () => {
                                cardInterface.nowPlayingController.toggleRemotePlay();
                            };
                        } else if (differenceY < 0) {
                            cardInterface.navigationControl.style.borderWidth = "2px 0 0 0";
                            procedureToExecute = () => {
                                const panelContainer = document.getElementById("panelContainer");
                                if (panelContainer.classList.contains("popIn")) {
                                    panelContainer.classList.replace("popIn", "popOut");
                                } else {
                                    panelContainer.classList.replace("popOut", "popIn");
                                }
                            };
                        }
                    }
                }

                function executeProcedure() {
                    procedureToExecute();
                    //Reinstate border
                    cardInterface.navigationControl.style.borderWidth = "2px 2px 2px 2px";
                    //Remove all previously added eventListeners
                    window.removeEventListener("touchmove", determineProcedure);
                    window.removeEventListener("mousemove", determineProcedure);
                    window.removeEventListener("touchend", executeProcedure);
                    window.removeEventListener("mouseup", executeProcedure);
                }
            }
        }
    </script>

</head>

<body>
    <div id="viewportContainer">
        <div id="nowPlayingViewport" class="viewport">
            <audio id="mediaController"></audio>
            <div id="sliderContainer">
                <p id="playlistDisplay">Playlist Name</p>
                <div id="seekSlider">
                    <div></div>
                </div>
                <div id="volumeSlider" style="transform: rotate(180deg)"></div>
            </div>
            <div id="displayContainer">
                <p id="artistDisplay">Track Name</p>
                <h1 id="titleDisplay">Artist</h1>
            </div>
            <div id="lyricsContainer">
                <div class="shadower" style="top: 0;"></div>
                <p id="lyricsDisplay">
                    <!-- Lyrics goes here -->
                </p>
                <div class="shadower" style="bottom: 0; background-image: linear-gradient(transparent, black, black);">
                </div>
            </div>
        </div>
    </div>

    <div id="panelContainer" class="popIn">
        <div id="playlistExplorerPanel" class="panel">
            <div class="panelDivision">

            </div>
            <div class="buttonContainer">
                <button id="addPlaylistButton" class="button" style="border-top-left-radius: 10px;">ADD</button>
            </div>
        </div>
    </div>

    <button id="navigationControl"></button>
</body>

<!-- quickAccessArea -->
<div id="quickAccessArea" style="display: none;">
    <div id="createControlsContainer">

    </div>
    <div id="retrieveControlsContainer">
        <button class="buttonGlyph"><span>&lt;</span></button>
        <button class="buttonGlyph"><span>PL</span></button>
        <button class="buttonGlyph"><span>&gt;</span></button>
    </div>
    <div id="updateControlsContainer">
        <button class="buttonGlyph"><span>RP</span></button>
    </div>
    <div id="deleteControlsContainer">

    </div>
</div>

<template id="templateContainer">
    <div class="panelDivisionSector">
        <h1 class="title"></h1>
    </div>

    <div class="panelDivisionSectorItem" data-playlist-index="" data-track-index="">
        Track Name
    </div>
</template>

</html>